"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([["5083"],{88816(e,a,t){t.d(a,{J3:()=>y,Lp:()=>c,T5:()=>m,Xh:()=>h,jB:()=>s,lw:()=>w,vX:()=>k,vc:()=>p,xE:()=>g});var l=t(46831),n=t(85020),i=t(90290);let{t:o}=l.Ay.global,r={fetchOptions:{loading:o("template.ai.loading.message"),successMessage:!0}};async function u(e,a){try{await n.K.post("/email_template/create",{temp_name:a,add_type:2,chat_id:e,html_content:""})}catch(e){throw console.warn(e),e}}async function s(e){await v(e),await d(e)}async function c(e){try{let a=`AI_temp_${new Date().getTime()}`,t=await n.K.post("/askai/chat/create_chat",{domain:e,add_type:99,temp_name:a},r);return await u(t.chatId,a),t.chatId}catch(e){return console.warn(e),null}}async function v(e){let{modelList:a,currentModel:t,currentModelTitle:l}=e;try{a.value=await n.K.post("/askai/supplier/models"),a.value.length&&(t.value=a.value[0],l.value=a.value[0].title)}catch(e){console.warn(e)}}async function d(e){let{chatId:a,chatInfo:t,currentModel:l,modelList:i,currentModelTitle:o,chatRecord:r,usageRecord:u}=e;try{if(t.value=await n.K.post("/askai/chat/info",{chatId:a.value}),t.value.modelId&&i.value.length){let e=i.value.find(e=>e.modelId==t.value.modelId);e&&(l.value=e,o.value=e.title)}for(let e=0;e<t.value.messages.length;e++){let a=`${t.value.messages[e].content}_+_${r.value.size}`;"user"==t.value.messages[e].role&&(r.value.set(a,f(t.value.messages[e+1].content)),u.value.set(a,t.value.messages[e+1].usage))}}catch(e){console.warn(e)}}async function p(e){let{chatId:a,isChat:t}=e;try{await n.K.post("/askai/chat/stop",{chatId:a.value},r),t.value=!1}catch(e){console.warn(e)}}async function m(e,a){let{scrollable:t,generateShow:l,chatId:r,currentModel:u,questionContent:s,chatRecord:c,currentChatRecordKey:v,scrollWrapperRef:d,chatScrollRef:p,isChat:m,usageRecord:h,useSpinTax:g,spinTaxLength:y}=e;if(m.value||!s.value||a&&(a.isComposing||229===a.keyCode)||a&&function(e,a){if(e.shiftKey&&"Enter"===e.key){e.preventDefault();let t=e.target,l=t.selectionStart,n=t.selectionEnd;return a.value=a.value.substring(0,l)+"\n"+a.value.substring(n),t.selectionStart=t.selectionEnd=l+1,!0}}(a,s))return;let w=`${s.value}_+_${c.value.size}`;c.value.set(w,[]),v.value=w;let _=s.value;s.value="";let b="",R=0;g.value&&(_+=`  ${o("template.ai.spintax.instruction",{count:y.value})}`);try{t.value=!0,l.value=!0,m.value=!0,(0,i.dY)(()=>p.value.scrollTo({left:0,top:d.value.offsetHeight})),await n.K.post("/askai/chat/chat",{chatId:r.value,supplierName:u.value.supplierName,modelId:u.value.modelId,content:_,is_text:"false"},{fetchOptions:{cancelResInterceptor:!0},responseType:"text",onDownloadProgress:e=>{l.value=!1;try{let l=e.event.target.responseText,n=l.slice(R);R=l.length;var a=function(e){let a=e.split("\n"),t=[];for(let e of a){let a=e.trim();if(a.startsWith("data:")){let e=a.slice(5).trim();e&&t.push(e)}}return t}(n);for(let e=0;e<a.length;e++)a[e]&&(b+=JSON.parse(a[e]).content);c.value.set(w,f(b)),t.value&&setTimeout(()=>p.value.scrollTo({left:0,top:d.value.offsetHeight}),200)}catch(e){console.warn(e)}}}),t.value=!0,p.value.scrollTo({left:0,top:d.value.offsetHeight}),m.value=!1,k(e,e=>{h.value.set(w,e)})}catch(e){console.warn(e)}finally{l.value=!1,b="",R=0}}function f(e){let a=/```[\s\S]*?(?:```|$)/g,t=e.match(a)||[],l=e.split(a),n=[],i=Math.max(l.length,t.length);for(let e=0;e<i;e++)e<l.length&&""!==l[e].trim()&&n.push(l[e]),e<t.length&&n.push(t[e]);return n}function h(e){return e.replace(/```html/g,"").replace(/```$/gm,"")}function g(e){return e.replace(/<<<<<<<\s+SEARCH[\s\S]*?=======([\s\S]*?)>>>>>>>\s+REPLACE/g,"$1")}function y(e){let a=e.match(/<title>(.*?)<\/title>/i);return a?a[1]:""}async function k(e,a){let{chatId:t,previewCode:l,previewTit:i}=e;try{let e=await n.K.post("/askai/chat/get_html",{chatId:t.value});l.value=e.html_content,i.value=y(l.value),a&&a(e.last_usage)}catch(e){console.warn(e)}}async function w(e){let{previewCode:a,chatId:t}=e;try{await n.K.post("/askai/chat/modify_html",{chatId:t.value,content:a.value},r),k(e)}catch(e){console.warn(e)}}},57105(e,a,t){t.d(a,{A:()=>$});var l=t(58653),n=t(18672),i=t(46835),o=t(27546),r=t(95403),u=t(90290),s=t(85020),c=t(88816),v=t(40528),d=t(22392);let p=t.p+"static/image/model-notice.a300ae20.png",m=t.p+"static/image/create-brand-info.5daf2552.png";var f=t(12532),h=t(23196),g=t(75220);let y={class:"wrapper"},k={class:"creation-methods"},w=["onClick"],_={class:"item-label"},b={class:"label"},R={key:0,class:"desc"},C={key:1},I={key:2},T={key:3},A={class:"flex justify-end"},E=(0,u.pM)({__name:"CreateTplModal",props:{onlyAi:{type:Boolean}},emits:["confirmType","hasCreateTpl"],setup(e,a){let{expose:t,emit:E}=a,$=(0,v.on)(),K=(0,g.rd)(),W=(0,u.KR)(["Drag","AI","HTML"]),F=(0,u.KR)("AI"),S=(0,u.KR)(""),x=(0,u.KR)(null),L=(0,u.KR)(!1),X=(0,u.KR)([]),D=(0,u.KR)(!1),M=(0,u.EW)(()=>e.onlyAi?["AI"]:W.value),N=(0,u.EW)(()=>{if(0==z.value.length)return"domain-list-empty";if(!D.value)return"ai-configuration-invalid";let e=X.value.find(e=>e.domain==S.value);return e&&1!==e.hasbrandinfo?"invalid-brand-domain":"normal"}),z=(0,u.EW)(()=>[...X.value].sort((e,a)=>a.hasbrandinfo-e.hasbrandinfo)),H=(0,u.EW)(()=>"AI"==F.value&&0==z.value.length);async function B(){if("AI"==F.value){if("invalid-brand-domain"==N.value){let e=X.value.find(e=>e.domain===S.value);try{await (0,d.nz)({domain:S.value,urls:e.urls}),(0,h.TP)(S.value,1)}catch(e){f.QB.error("Failed to initialize AI configuration, please try again later."),console.warn(e)}}let e=await (0,c.Lp)(S.value);e&&($.domainSource=S.value,K.push({name:"ai-template",params:{chatId:e}}))}else E("confirmType",F.value)}function O(){K.push({name:"Domain",query:{init:"init-domain"}})}function P(){K.push({name:"AiModel"})}function U(){K.push({name:"EditDomain",params:{domain:S.value}})}function j(e){return e.hasbrandinfo?(0,u.bF)("div",null,[(0,u.bF)("i",{class:"i-domain:brand-info w-4 h-4 mr-1.25"},null),(0,u.eW)(" "),(0,u.bF)("span",null,[e.domain])]):(0,u.bF)("span",null,[e.domain])}async function G(){let e=await s.K.get("/domains/list",{params:{page:1,page_size:100}});if((0,f.Gv)(e)&&(X.value=e.list||[]),x.value=X.value.find(e=>e.domain===S.value)||null,0==X.value.length){$.domainSource="",S.value="";return}$.domainSource&&(S.value=$.domainSource),z.value.length>0&&(S.value=z.value[0].domain,$.domainSource=z.value[0].domain)}return t({open:async function e(){let e=await (0,d.pC)();(0,f.Gv)(e)&&(D.value=e.is_configured),await G(),$.domainSource&&($.domainSource=S.value),L.value=!0},close:function(){L.value=!1}}),(e,a)=>{let t=r.A,s=o.Ay,c=i.A,v=n.Ay,d=l.A;return(0,u.uX)(),(0,u.Wv)(d,{show:(0,u.R1)(L),"onUpdate:show":a[1]||(a[1]=e=>(0,u.i9)(L)?L.value=e:null),preset:"card",draggable:"","close-on-esc":!1,"mask-closable":!1,segmented:"",class:"w-110",title:""},{footer:(0,u.k6)(()=>[(0,u.Lk)("div",A,["AI"==(0,u.R1)(F)?((0,u.uX)(),(0,u.Wv)(s,{key:0,type:"primary",disabled:(0,u.R1)(H)||["domain-list-empty","ai-configuration-invalid"].includes((0,u.R1)(N)),onClick:B},{default:(0,u.k6)(()=>[(0,u.eW)((0,u.v_)(e.$t("template.createTpl.create")),1)]),_:1},8,["disabled"])):((0,u.uX)(),(0,u.Wv)(s,{key:1,type:"primary",onClick:B},{default:(0,u.k6)(()=>[(0,u.eW)((0,u.v_)(e.$t("template.createTpl.create")),1)]),_:1}))])]),default:(0,u.k6)(()=>[(0,u.Lk)("div",y,[(0,u.Lk)("div",k,[((0,u.uX)(!0),(0,u.CE)(u.FK,null,(0,u.pI)((0,u.R1)(M),(e,a)=>((0,u.uX)(),(0,u.CE)("div",{key:a,class:(0,u.C4)(["choose-item",{active:(0,u.R1)(F)==e}]),onClick:a=>F.value=e},[(0,u.Lk)("span",_,(0,u.v_)(e),1)],10,w))),128))]),(0,u.Lk)("div",{class:(0,u.C4)(["url-source",{hidden:"AI"!==(0,u.R1)(F)}])},[(0,u.Lk)("span",b,(0,u.v_)(e.$t("template.createTpl.sourceUrl")),1),(0,u.bF)(t,{value:(0,u.R1)(S),"onUpdate:value":a[0]||(a[0]=e=>(0,u.i9)(S)?S.value=e:null),class:"flex-1","label-field":"domain","value-field":"domain",options:(0,u.R1)(z),disabled:(0,u.R1)(H),"render-label":j},null,8,["value","options","disabled"])],2),"normal"==(0,u.R1)(N)?((0,u.uX)(),(0,u.CE)("div",R,(0,u.v_)(e.$t("template.createTpl.useAiTools")),1)):"domain-list-empty"==(0,u.R1)(N)?((0,u.uX)(),(0,u.CE)("div",C,[(0,u.eW)((0,u.v_)(e.$t("template.createTpl.notices.domainListEmpty"))+", ",1),(0,u.bF)(s,{text:"",type:"primary",onClick:O},{default:(0,u.k6)(()=>[(0,u.eW)((0,u.v_)(e.$t("template.createTpl.buttons.createNow")),1)]),_:1})])):"ai-configuration-invalid"==(0,u.R1)(N)?((0,u.uX)(),(0,u.CE)("div",I,[(0,u.eW)((0,u.v_)(e.$t("template.createTpl.notices.aiConfigurationInvalid"))+", ",1),(0,u.bF)(v,{trigger:"hover",placement:"right"},{trigger:(0,u.k6)(()=>[(0,u.bF)(s,{text:"",type:"primary",onClick:P},{default:(0,u.k6)(()=>[(0,u.eW)((0,u.v_)(e.$t("template.createTpl.buttons.configureNow")),1)]),_:1})]),default:(0,u.k6)(()=>[(0,u.bF)(c,{src:(0,u.R1)(p),width:"600"},null,8,["src"])]),_:1})])):"invalid-brand-domain"==(0,u.R1)(N)?((0,u.uX)(),(0,u.CE)("div",T,[(0,u.eW)((0,u.v_)(e.$t("template.createTpl.notices.invalidBrandDomain"))+", ",1),(0,u.bF)(v,{trigger:"hover",placement:"right"},{trigger:(0,u.k6)(()=>[(0,u.bF)(s,{text:"",type:"primary",onClick:U},{default:(0,u.k6)(()=>[(0,u.eW)((0,u.v_)(e.$t("template.createTpl.buttons.createNow")),1)]),_:1})]),default:(0,u.k6)(()=>[(0,u.bF)(c,{src:(0,u.R1)(m),width:"600"},null,8,["src"])]),_:1})])):(0,u.Q3)("",!0)])]),_:1},8,["show"])}}}),$=(0,t(64901).default)(E,[["__scopeId","data-v-ee23f589"]])}}]);